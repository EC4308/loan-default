---
title: "EC4308 Project (Lending Club)"
author: "Brandon, LX, WT, YH, ZH"
date: "2024-10-11"
output: html_document
---

## Initial setup
```{r setup, include=FALSE}
library(readr)
library(tidyverse)
library(jsonlite)
library(lubridate)
library(zoo)
library(dplyr)
library(rpart)
library(rpart.plot)

data <- readRDS("../data/combined_data.rds")
```

## Training/Test Split
```{r}
# Set seed
set.seed(123)

n <- nrow(data)  

# Define the proportion for each set
train_ratio <- 0.6  # 60% for training
validation_ratio <- 0.2  # 20% for validation
test_ratio <- 0.2  # 20% for testing

train_indices <- sample(seq_len(n), size = train_ratio * n)
remaining_indices <- setdiff(seq_len(n), train_indices)

validation_indices <- sample(remaining_indices, size = validation_ratio * n)
test_indices <- setdiff(remaining_indices, validation_indices)

train_data <- data[train_indices, ]
validation_data <- data[validation_indices, ]
test_data <- data[test_indices, ]

#Check the sizes of each set
cat("Train size: ", nrow(train_data), "\n")
cat("Validation size: ", nrow(validation_data), "\n")
cat("Test size: ", nrow(test_data), "\n")

```

## Baseline model - Decision tree with depth 7
For refresher purposes, 0 is a good loan, 1 is a bad loan
### Creating the tree
```{r}
baseline_tree <- rpart(loan_status_bin ~., 
                       data = train_data, 
                       method = "class", 
                       control = rpart.control(maxdepth = 7))

```


### Print the tree
```{r}
rpart.plot(baseline_tree)
```
### Predict on test data
```{r}
predictions <- predict(baseline_tree, test_data, type = "class")
```

### Confusion Matrix
```{r}
confusion_matrix <- table(test_data$loan_status_bin, predictions)
accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
confusion_matrix
accuracy
```
### Cost of FN
```{r}
test_data <- test_data %>% ungroup()

test_data_with_predictions <- test_data %>%
  mutate(predicted = predictions)

false_negatives <- test_data_with_predictions %>%
  filter(loan_status_bin == 1 & predicted == 0)

#Calculate the potential money lost due to FN
potential_money_lost <- sum(false_negatives$funded_amnt, na.rm = TRUE)

cat("Potential money lost due to False Negatives: $", potential_money_lost, "\n")

```

